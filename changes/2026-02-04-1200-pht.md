# 2026-02-04 12:00 PHT — Google Maps Platform Migration

## Summary

Replaced the entire free maps stack (OSMDroid + Nominatim + Photon + OSRM) with Google Maps Platform. The mobile↔backend HTTP contract is unchanged — no other module or screen required modification.

---

## Motivation

The client provided a Google Maps API key (`AIzaSyBFL3DoNss040CSPCEWw2OaIINqqP1Y0lI`). Google Maps provides more accurate geocoding, richer autocomplete (with structured formatting), live-traffic-capable routing, and official Android map tiles versus the previous free-tier OSM-based stack.

---

## Files Changed (7)

### Backend

#### 1. `apps/api/.env.example`
- **Removed:** `NOMINATIM_API_URL`, `PHOTON_API_URL`, `OSRM_API_URL`
- **Added:** `GOOGLE_MAPS_API_KEY`

#### 2. `apps/api/src/location/location.service.ts`
Five API-calling methods rewritten; Haversine block frozen.

| Method | Old provider | New provider | Key difference |
|--------|-------------|--------------|----------------|
| `geocode()` | Nominatim `/search` | Google Geocoding API | Returns `place_id` (Google native) |
| `reverseGeocode()` | Nominatim `/reverse` | Google Geocoding API | `latlng` param replaces `lat`+`lon` |
| `getPlaceAutocomplete()` | Photon `/api` | Google Places Autocomplete | Does **not** return lat/lng; `ZERO_RESULTS` handled as success |
| `getPlaceDetails()` | Nominatim `/lookup` | Google Place Details | Field-masked (`name,formatted_address,geometry/location,types`) for cheapest billing tier; dead Photon short-circuit removed |
| `getDistanceMatrix()` | OSRM `/route/v1/driving` | Google Distance Matrix | Same Haversine fallback on failure; uses `duration` (static, no live traffic) |

**Frozen block (unchanged byte-for-byte):**
`getHaversineFallback`, `formatDuration`, `calculateHaversineDistance`, `isWithinRadius`, `isWithinRadiusMeters`, `toRadians` — called by `geofence.service.ts` and `ride.service.ts`.

#### 3. `apps/api/src/location/dto/place-autocomplete.dto.ts`
Comments-only. Four Photon-specific comments updated to Google Places. Optional `latitude`/`longitude` fields retained on `PlacePredictionDto` and `PlaceDetailsRequestDto` for DTO compatibility — they are simply not populated by Google.

### Mobile

#### 4. `apps/mobile/app/build.gradle.kts`
```diff
-    implementation("org.osmdroid:osmdroid-android:6.1.18")
+    implementation("com.google.android.gms:play-services-maps:18.2.0")
+    implementation("com.google.maps.android:maps-compose:4.2.0")
```
`play-services-location:21.1.0` (FusedLocationProvider / device GPS) left untouched.
`maps-compose:4.2.0` chosen because it targets `compose-bom:2023.09.01` — compatible with the project's `compileSdk = 34`. The latest `8.0.1` requires compileSdk 36.

#### 5. `apps/mobile/app/src/main/AndroidManifest.xml`
Added `<meta-data>` with the API key as the first child of `<application>`. The Maps SDK reads this at init; there is no programmatic alternative.

#### 6. `apps/mobile/app/src/main/java/com/wheelsongo/app/ui/components/map/OpenStreetMap.kt`
Full rewrite. Same file path, same package.

| Removed (OSMDroid) | Replaced with (Google Maps Compose) |
|--------------------|--------------------------------------|
| `AndroidView` wrapping `MapView` | Native `GoogleMap` composable |
| `DisposableEffect` + `LifecycleEventObserver` | Maps Compose handles lifecycle internally |
| `setOnTouchListener` + pixel-to-geo projection | `onMapClick` callback |
| `updateMarkers()` standalone function + `map.invalidate()` | Conditional `Marker` composables — recomposition handles lifecycle |
| `LaunchedEffect(Unit)` OSMDroid config init | Maps SDK reads config from manifest |

Composable renamed `OpenStreetMapView` → `GoogleMapView`. Parameter signature identical.

#### 7. `apps/mobile/app/src/main/java/com/wheelsongo/app/ui/screens/home/HomeScreen.kt`
Three surgical lines only:
1. Import: `OpenStreetMapView` → `GoogleMapView`
2. Comment: `// OpenStreetMap (FREE - no billing required)` → `// Google Maps`
3. Composable call: `OpenStreetMapView(` → `GoogleMapView(`

All parameters passed to the composable remain unchanged.

---

## What Was NOT Changed (and why)

| File | Reason |
|------|--------|
| `location.controller.ts` | Public HTTP contract — endpoints, params, response shapes are provider-agnostic |
| `location.module.ts` | Already imports `HttpModule` (10s timeout) + `ConfigModule` |
| `geocode.dto.ts` | Already provider-agnostic |
| `geofence.service.ts` | Only calls frozen Haversine methods |
| `dispatch.service.ts` | Uses raw SQL Haversine; injects `LocationService` but never calls it |
| `ride.service.ts` | Calls `getDistanceMatrix()` — same method name + DTO, new internals |
| `PlaceSearchViewModel.kt` | Already has a two-path flow: checks `prediction.latitude != null`. With Google, always null → path (b) (`getPlaceDetails`) always fires. Existing code handles this correctly. |
| `LocationModels.kt` | `PlacePrediction.latitude: Double? = null` — Moshi deserialises absent JSON fields as `null` |
| `LocationApi.kt` | Retrofit interface to our own backend; endpoint paths unchanged |
| `LocationService.kt` | FusedLocationProvider — device GPS, not maps |
| `settings.gradle.kts` | `google()` repo already present |

---

## Behavioral differences vs. previous stack

| Area | Before (Photon/OSRM) | After (Google) | Impact |
|------|----------------------|----------------|--------|
| Autocomplete coordinates | Returned directly in predictions | Not returned; Place Details call always required | `PlaceSearchViewModel` path (b) fires every time — already handled |
| Session tokens | Not used | Grouped autocomplete + Details for billing optimisation | No mobile change; backend forwards `sessiontoken` (lowercase) to Google |
| Distance text | `"X.X km"` on success, `"X.X km (estimated)"` on Haversine fallback | Same | Unchanged |
| Autocomplete type filter | No filter by default | No filter by default (only added when `dto.types` explicitly set) | Matches previous behaviour |

---

## Build verification

- **Backend:** `npm run build:api` — 0 TypeScript errors.
- **Mobile:** `gradle assembleDebug` — BUILD SUCCESSFUL (37 tasks, 18 executed).

---

## Smoke test checklist (run manually after deployment)

### Backend
1. `POST /location/geocode` — body `{ "address": "SM Mall of Asia, Manila" }` → valid lat/lng/placeId
2. `POST /location/reverse-geocode` — body `{ "latitude": 14.5995, "longitude": 120.9842 }` → valid address
3. `GET /location/autocomplete?input=Rockwell` → predictions array; each has `placeId`, no `latitude`/`longitude`
4. `GET /location/place/:placeId` (from step 3) → has `latitude` + `longitude`
5. `POST /location/distance` — two Manila coordinates → `distanceMeters`, `durationSeconds`, `durationText`

### Mobile
6. Install debug APK on emulator with Google Play Services image. Map renders Google tiles centered on Metro Manila.
7. Tap map → pin emoji appears at tapped coordinate.
8. Tap "My Location" FAB → map animates to GPS position.
9. Tap "From" → PlaceSearch → type "Rockwell" → list appears → select → green marker on map.
10. Tap "To" → same flow → red marker on map.
