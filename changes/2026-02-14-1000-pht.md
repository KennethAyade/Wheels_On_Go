# Phase 2 Week 4 — Core Booking Engine

**Date:** 2026-02-14 10:00 PHT
**Phase:** Phase 2 (Booking Engine, Weeks 4–6)

---

## Summary

Week 4 delivers the complete core booking engine: RiderVehicle CRUD, surge pricing, promo codes, WebSocket dispatch, and the full mobile booking flow (BookingConfirm → ActiveRide).

---

## Backend Changes

### New Module: RiderVehicle CRUD
- `apps/api/src/rider-vehicle/rider-vehicle.module.ts` — NestJS module
- `apps/api/src/rider-vehicle/rider-vehicle.service.ts` — create, list, delete, setDefault
- `apps/api/src/rider-vehicle/rider-vehicle.controller.ts` — REST endpoints (POST, GET, DELETE, PATCH)
- `apps/api/src/rider-vehicle/dto/` — CreateRiderVehicleDto, UpdateRiderVehicleDto
- `apps/api/test/rider-vehicle.service.spec.ts` — 10 unit tests

**Endpoints:**
- `POST /rider-vehicles` — register a vehicle
- `GET /rider-vehicles` — list rider's vehicles
- `DELETE /rider-vehicles/:id` — remove a vehicle
- `PATCH /rider-vehicles/:id/default` — set default vehicle

### Surge Pricing
- `apps/api/src/pricing/surge-pricing.service.ts` — Haversine formula for demand/supply density
- Tiered multipliers: 1.0x → 1.25x → 1.5x → 1.75x → 2.0x based on demand/supply ratio

### Promo Codes
- `apps/api/src/pricing/promo-code.service.ts` — validate and apply promo codes
- Supports PERCENTAGE and FIXED_AMOUNT discount types
- Validates: expiry, usage limit, minimum fare, ride type eligibility

### Dispatch Integration
- `apps/api/src/dispatch/dispatch.service.ts` — WebSocket gateway for real-time driver dispatch
- `apps/api/src/rides/rides.service.ts` — ride creation triggers dispatch event
- `apps/api/src/rides/rides.controller.ts` — POST /rides with fare estimate + surge + promo

---

## Mobile Changes

### Data Layer
- `apps/mobile/.../data/models/booking/BookingModels.kt` — FareEstimate, RideRequest, RideResponse, PromoCode, RideStatus
- `apps/mobile/.../data/models/vehicle/VehicleModels.kt` — RiderVehicle, CreateVehicleRequest
- `apps/mobile/.../data/network/RidesApi.kt` — Retrofit interface for rides (POST /rides, GET /rides/estimate)
- `apps/mobile/.../data/network/VehicleApi.kt` — Retrofit interface for vehicles
- `apps/mobile/.../data/repository/RidesRepository.kt` — ride creation, fare estimate, promo validation
- `apps/mobile/.../data/repository/VehicleRepository.kt` — vehicle CRUD
- `apps/mobile/.../data/websocket/RideWebSocketClient.kt` — Socket.IO client for ride events
- `apps/mobile/.../data/network/ApiClient.kt` — added ridesApi, vehicleApi

### Screens
- `apps/mobile/.../ui/screens/vehicle/VehicleRegistrationScreen.kt` — NEW: plate number, make, model, color form with validation
- `apps/mobile/.../ui/screens/vehicle/VehicleListScreen.kt` — NEW: list with swipe-to-delete and default selection
- `apps/mobile/.../ui/screens/booking/BookingConfirmScreen.kt` — NEW: fare estimate display, vehicle dropdown, promo code input, surge badge
- `apps/mobile/.../ui/screens/booking/BookingConfirmViewModel.kt` — NEW: fare fetching, promo validation, vehicle loading
- `apps/mobile/.../ui/screens/ride/ActiveRideScreen.kt` — NEW: real-time map with driver ETA, cancel ride
- `apps/mobile/.../ui/screens/ride/ActiveRideViewModel.kt` — NEW: WebSocket event handling (driver_assigned, ride_started, ride_completed, ride_cancelled)

### Navigation
- `apps/mobile/.../AppNav.kt` — Home → BookingConfirm → ActiveRide; VehicleRegistration from drawer menu

---

## Tests

### Backend (13 suites, 121 tests passing)
- rider-vehicle.service.spec.ts: 10 tests (create, list, delete, setDefault, conflict, not found)

### Mobile (12 files, 87 tests — compile OK, blocked by JBR-21 JVM crash)
New test files:
- `BookingConfirmViewModelTest.kt` — fare estimate loading, promo validation, vehicle selection
- `ActiveRideViewModelTest.kt` — WebSocket event handling, ride state transitions
- `RidesRepositoryTest.kt` — API call mocking, error handling
- `VehicleRepositoryTest.kt` — CRUD operations, error parsing
- `VehicleRegistrationViewModelTest.kt` — form validation, submission

---

## APK Build
- `app-debug.apk` — builds and installs successfully
- All compilation errors resolved
