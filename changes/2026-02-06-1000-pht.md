# 2026-02-06 10:00 PHT — FR-1.2 KYC Upload + FR-1.3 Biometric Verification

**Scope:** Complete driver KYC document upload with Cloudflare R2 storage and biometric face verification screen.

---

## Problem Statement

1. **FR-1.2 (Driver KYC):** KYC upload endpoints were returning 503 because no storage backend was configured. Mobile document upload was simulated with mock delays.
2. **FR-1.3 (Biometric Login):** Backend biometric verification was complete (AWS Rekognition + mock mode), but the mobile app had no BiometricVerificationScreen, no camera integration, and no navigation route.
3. **DTO Mismatches:** Mobile models used field names that did not match backend DTOs, which would cause silent JSON deserialization failures.

---

## Solution

### 1. Cloudflare R2 Storage Configuration

Configured Cloudflare R2 as the S3-compatible storage backend (free tier: 10GB storage, 10M reads/month, 1M writes/month).

**Files changed:**
- `apps/api/.env` — Added R2 credentials (STORAGE_BUCKET, STORAGE_ENDPOINT, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, STORAGE_REGION=auto)
- `apps/api/.env.example` — Updated template with R2 configuration documentation

### 2. Enabled KYC Endpoints

Removed `ServiceUnavailableException` blocks from `driver.controller.ts` so the presign and confirm endpoints now call the actual service methods.

**File changed:** `apps/api/src/driver/driver.controller.ts`

### 3. Fixed Mobile DTO Field Name Mismatches

**KYC DTOs (`DriverModels.kt`):**
| Mobile (before) | Backend (expected) | Fixed |
|---|---|---|
| `documentType` | `type` | `type` |
| `contentType` | `mimeType` | `mimeType` |
| `fileExtension` | `fileName` | `fileName` |
| (missing) | `size` | `size: Long` |
| `s3Key` | `key` | `key` |

**Biometric DTOs (`AuthModels.kt`):**
| Mobile (before) | Backend (expected) | Fixed |
|---|---|---|
| `imageBase64` | `liveImageBase64` | `liveImageBase64` |
| `verified` | `match` | `match` |
| (missing) | `userId` | `userId: String` |
| (missing) | `accessToken` | `accessToken: String` |

### 4. Real KYC File Upload Pipeline

Rewrote `DocumentUploadViewModel.kt` from `ViewModel` to `AndroidViewModel` (needs Application context for ContentResolver). Implemented the full 3-step upload:

1. **Presign:** `POST /drivers/kyc/presign` with `{type, fileName, mimeType, size}` → returns `{uploadUrl, key}`
2. **Upload:** `PUT uploadUrl` with file bytes and Content-Type header (OkHttp, 120s write timeout)
3. **Confirm:** `POST /drivers/kyc/confirm` with `{type, key, size}` → confirms upload in database

Added `ActivityResultContracts.GetContent()` file picker to `DocumentUploadScreen.kt` — launches with `image/*` MIME type.

### 5. Biometric Verification Flow

**Token flow:**
```
OTP verify (driver with profile photo)
  → biometricRequired=true, biometricToken (5min TTL), accessToken=null
  → TokenManager saves biometricToken
  → Navigate to BiometricVerificationScreen
  → Camera captures selfie → Base64 encode
  → POST /auth/biometric/verify (biometric token in Authorization header)
  → Backend returns {userId, accessToken, confidence, match}
  → TokenManager saves accessToken, clears biometricToken
  → Navigate to LocationConfirm → Home
```

**New files:**
- `BiometricVerificationViewModel.kt` — Captures bitmap, encodes to Base64 JPEG, calls `authRepository.verifyBiometric()`
- `BiometricVerificationScreen.kt` — UI with face icon, camera intent (`TakePicturePreview`), error display, retry button

**Modified files:**
- `TokenManager.kt` — Added `saveBiometricToken()`, `getBiometricToken()`, `clearBiometricToken()`
- `AuthInterceptor.kt` — Uses biometric token (not access token) for `/auth/biometric/verify` requests
- `AuthRepository.kt` — Added `verifyBiometric()` method; saves biometric token on OTP verify
- `OtpVerificationViewModel.kt` — Tracks `biometricRequired` in UI state
- `OtpVerificationScreen.kt` — Added `onBiometricRequired` callback
- `Routes.kt` — Added `BiometricVerification` route
- `AppNav.kt` — Wired biometric screen between OTP and LocationConfirm

### 6. Camera Permission

Added to `AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.CAMERA" />
<uses-feature android:name="android.hardware.camera" android:required="false" />
```

---

## Build Verification

- **API:** `npm run build:api` — BUILD SUCCESSFUL
- **Mobile:** `./gradlew assembleDebug` — BUILD SUCCESSFUL (37 tasks, 10s)

---

## Navigation Flow (Updated)

```
Rider:   Welcome → PhoneInput → OTP → LocationConfirm → Home
Driver (new):       Welcome → PhoneInput → OTP → LocationConfirm → DocumentUpload → Home
Driver (returning): Welcome → PhoneInput → OTP → BiometricVerification → LocationConfirm → Home
```

---

## Week 3 Final Status

| Backlog Item | Status | Completion |
|---|---|---|
| FR-1.1 OTP Auth | COMPLETE | 100% |
| FR-1.2 Driver KYC | COMPLETE | 95% (admin dashboard UI pending) |
| FR-1.3 Biometric Login | COMPLETE | 90% (liveness detection enhancement pending) |
