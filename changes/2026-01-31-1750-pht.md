# OTP Verification Critical Fixes - 2026-01-31 17:50 PHT

## Summary
Fixed three critical issues preventing OTP verification from working: backend/mobile API response structure mismatch, URL encoding issue with phone number special characters, and UX issue with OTP error handling.

## Issues Fixed

### Issue #1: API Response Structure Mismatch (CRITICAL)
**Problem:** Backend returned incompatible JSON structure causing mobile app parsing failures.

**Backend was returning:**
```json
{
  "userId": "uuid",
  "role": "DRIVER",
  "biometricRequired": false,
  "accessToken": "jwt-token"
}
```

**Mobile app expected:**
```json
{
  "accessToken": "jwt-token",
  "refreshToken": "refresh-token",
  "user": {
    "id": "uuid",
    "phoneNumber": "+639...",
    "role": "DRIVER",
    "isActive": true,
    "createdAt": "2026-01-31T09:50:00Z"
  }
}
```

**Root Cause:** Week 3 integration created new mobile models but backend response format wasn't updated to match.

**Fix:** Updated `apps/api/src/auth/auth.service.ts` (lines 55-77) to return correct structure:
- RIDER response (lines 66-77): Standard auth response with user object
- DRIVER response (lines 55-68): Auth response + biometric fields (biometricRequired, biometricToken, biometricEnrolled, driverStatus)

---

### Issue #2: URL Encoding Bug - Phone Number `+` Symbol
**Problem:** Phone number `+639617800476` became ` 639617800476` (space instead of +) causing backend validation to reject requests with "phoneNumber must be in E.164 format" error.

**Root Cause:** Navigation route passed phone number in URL path:
```kotlin
"otp_verification/$phoneNumber/$role"  // becomes "otp_verification/+639617800476/RIDER"
```

The `+` symbol is a special URL character representing a space. Android's navigation component URL-decoded it, converting `+639617800476` → ` 639617800476`.

**Backend Error:**
```json
{
  "message": ["phoneNumber must be in E.164 format (e.g. +639XXXXXXXXX)"],
  "error": "Bad Request",
  "statusCode": 400
}
```

**Fix:** Updated `apps/mobile/.../ui/navigation/Routes.kt` to URL-encode phone number:
```kotlin
fun createRoute(phoneNumber: String, role: String): String {
    // URL encode phone number to preserve + symbol
    val encodedPhone = URLEncoder.encode(phoneNumber, StandardCharsets.UTF_8.toString())
    return "otp_verification/$encodedPhone/$role"
}
```

Now `+639617800476` → `%2B639617800476` (URL encoded) → `+639617800476` (correctly decoded).

---

### Issue #3: OTP Clear on Error - Backspace Disabled
**Problem:** When OTP verification failed, the error handler cleared the OTP value, preventing users from backspacing to fix typos.

**Root Cause:** `OtpVerificationViewModel.kt` line 131 set `otpValue = ""` on failure, causing the backspace guard `if (currentOtp.isNotEmpty())` to fail.

**Fix:** Removed the `otpValue = ""` line - preserve OTP on error to allow corrections:
```kotlin
onFailure = { error ->
    _uiState.update {
        it.copy(
            isLoading = false,
            // Don't clear otpValue - let user backspace to fix their input
            errorMessage = error.message ?: "Verification failed. Please try again."
        )
    }
}
```

**UX Improvement:** Users can now backspace and re-enter digits instead of starting over. Error message auto-clears when editing begins.

---

## Supporting Changes

### Mobile - Handle Nullable Access Tokens (Driver Biometric Flow)
Drivers requiring biometric authentication receive `null` accessToken until biometric verification completes.

**Updated Files:**
1. `apps/mobile/.../data/models/auth/AuthModels.kt`:
   - Made `accessToken` nullable: `val accessToken: String?`
   - Added optional driver fields: `biometricRequired`, `biometricToken`, `biometricEnrolled`, `driverStatus`

2. `apps/mobile/.../data/auth/TokenManager.kt`:
   - Updated `saveTokens()` to use safe call: `response.accessToken?.let { prefs[ACCESS_TOKEN_KEY] = it }`

3. `apps/mobile/.../data/repository/AuthRepository.kt`:
   - Added null check before saving tokens:
   ```kotlin
   if (body.accessToken != null) {
       tokenManager.saveTokens(body)
   }
   ```

### Backend - Debug Logging
Added request logging to `apps/api/src/auth/auth.controller.ts` for troubleshooting:
```typescript
@Post('verify-otp')
verifyOtp(@Body() dto: VerifyOtpDto) {
  this.logger.log(`Verify OTP request: ${JSON.stringify({
    phoneNumber: dto.phoneNumber,
    role: dto.role,
    codeLength: dto.code?.length
  })}`);
  return this.authService.verifyOtp(dto);
}
```

Logs show exact phone number format, role, and OTP code length for validation debugging.

---

## Files Modified

### Backend (2 files)
| File | Lines | Change |
|------|-------|--------|
| `apps/api/src/auth/auth.service.ts` | 55-77 | Fixed response structure for RIDER and DRIVER |
| `apps/api/src/auth/auth.controller.ts` | 24-27 | Added debug logging for verify-otp endpoint |

### Mobile (6 files)
| File | Lines | Change |
|------|-------|--------|
| `apps/mobile/.../data/models/auth/AuthModels.kt` | 59-66 | Made accessToken nullable, added driver fields |
| `apps/mobile/.../data/auth/TokenManager.kt` | 38-45 | Handle nullable accessToken in saveTokens() |
| `apps/mobile/.../data/repository/AuthRepository.kt` | 82-87 | Added null check before saving tokens |
| `apps/mobile/.../ui/navigation/Routes.kt` | 3-4, 38-42 | URL encode phone number to preserve + symbol |
| `apps/mobile/.../ui/screens/auth/OtpVerificationViewModel.kt` | 127-135 | Don't clear OTP on error (preserve for backspace) |

---

## Testing Verification

### Before Fixes
```
Mobile Log: {"phoneNumber":" 639617800476","code":"337459","role":"RIDER"}
Backend Error: {"message":["phoneNumber must be in E.164 format"],"statusCode":400}
Result: "Invalid request. Please check your input." - User blocked
```

### After Fixes
```
Mobile Log: {"phoneNumber":"+639617800476","code":"337459","role":"RIDER"}
Backend Log: [AuthController] Verify OTP request: {"phoneNumber":"+639617800476","role":"RIDER","codeLength":6}
Backend Success: Returns {accessToken, user: {...}}
Result: User successfully logged in, navigates to home screen
```

---

## Impact

**Critical:** This unblocks the entire Week 3 authentication flow. Users can now:
1. ✅ Request OTP with proper phone number format
2. ✅ Verify OTP and receive JWT tokens
3. ✅ Successfully log in to the app
4. ✅ Persist sessions across app restarts
5. ✅ Backspace to fix OTP typos

**Driver Flow:** Biometric authentication flow now properly handles null access tokens, allowing drivers with profile photos to complete biometric verification before receiving their JWT.

---

## Related Context

### Prisma phoneNumberHash Issue (Separate)
The Prisma Client `phoneNumberHash` error mentioned in earlier troubleshooting was resolved by running `npm run prisma:generate`. This was a prerequisite for the backend to work but was not part of this fix set.

### Week 3 Integration Status
- ✅ Mobile UI connected to backend OTP APIs
- ✅ JWT token storage and persistence
- ✅ Auth interceptor for protected endpoints
- ✅ Response structure alignment
- ✅ URL encoding for navigation arguments
- ⚠️ KYC document upload (disabled pending S3 credentials)

---

## Prevention

To prevent similar issues in the future:

1. **API Contract Testing:** Add integration tests that validate request/response JSON structures match between mobile and backend
2. **URL Parameter Encoding:** Always URL-encode navigation arguments containing special characters (`+`, `/`, `?`, `&`, `#`, `=`)
3. **Error State UX:** Consider user corrections in error handling - avoid clearing user input on failures
4. **Type Safety:** Use shared TypeScript/Kotlin type definitions or OpenAPI specs to enforce API contracts

---

## Co-Authored-By
Claude Sonnet 4.5 <noreply@anthropic.com>
