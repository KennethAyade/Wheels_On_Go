# Driver Booking Flow — Week 5 Implementation + Bug Fixes

**Date:** 2026-02-20 14:00 PHT
**Type:** New feature + Bug fixes + Warning cleanup

---

## Summary

Three categories of changes:
1. **Week 5 driver-side booking flow** — DriveRequestsScreen, DriverActiveRideScreen overhaul, DriverTripCompletionScreen, backend dispatch payload normalization, DispatchSocketClient nested-JSON fix
2. **Two bug fixes** — (Critical) activeRideId navigation loop after trip completion; (Minor UX) fare displayed as `₱1500.0` instead of `₱1500`
3. **Build warning cleanup** — Deprecated `Icons.Default.Chat` → `Icons.AutoMirrored.Filled.Chat`; removed unused imports

---

## Feature 1: DriveRequestsScreen

**File:** `apps/mobile/app/src/main/java/com/wheelsongo/app/ui/screens/driver/DriveRequestsScreen.kt` (NEW)

Drivers see this screen after tapping "Find Drive Requests" on DriverHome. Shares `DriverHomeViewModel` with the Home screen via `navController.getBackStackEntry(Route.Home.value)`.

### UI Components
- **WaitingForRequestsContent** — `CircularProgressIndicator` + "Waiting for Ride Requests..." shown when `pendingRequests` is empty
- **DriveRequestCard** — per-request card displaying:
  - Rider initials avatar + name
  - Booking meta: `Now/Scheduled · <distance> · <walk-time> · <payment>`
  - Fare in large green text (`₱<amount>`)
  - Pickup and dropoff addresses
  - Duration + distance row
  - **Apply** / **Dismiss** buttons → `viewModel.acceptRide()` / `viewModel.declineRide()`
- **CurrentLocationBar** — bottom sticky bar showing driver's current address
- **BackHandler** — going back toggles driver offline and pops to DriverHome

### Utilities (inlined)
- `haversineMeters(lat1, lng1, lat2, lng2): Int` — Haversine distance in meters
- `String.initials()` — 1-2 uppercase initials from name
- `paymentLabel(method)` — GCASH→GCash, CARD→Card, else Cash

---

## Feature 2: DriverActiveRideScreen + DriverActiveRideViewModel

### DriverActiveRideViewModel

**File:** `apps/mobile/app/src/main/java/com/wheelsongo/app/ui/screens/driver/DriverActiveRideViewModel.kt` (NEW)

```kotlin
data class DriverActiveRideUiState(
    val ride: RideResponse? = null,
    val isLoading: Boolean = false,
    val isActionInProgress: Boolean = false,
    val rideStatus: String = "PENDING",
    val driverLat: Double = 0.0,
    val driverLng: Double = 0.0,
    val errorMessage: String? = null,
    val navigateToCompletion: Boolean = false
)
```

State machine:
- `initialize(rideId)` — loads ride from `RideRepository.getRideById()`, starts location loop
- `arriveAtPickup()` → `POST /rides/{id}/arrive` → status ARRIVED_AT_PICKUP
- `startRide()` → `POST /rides/{id}/start` → status IN_PROGRESS
- `completeRide()` → `POST /rides/{id}/complete` → sets `navigateToCompletion = true`
- Location tracking loop every 5s: calls `TrackingApi.updateLocation()`

### DriverActiveRideScreen (OVERHAULED)

**File:** `apps/mobile/app/src/main/java/com/wheelsongo/app/ui/screens/driver/DriverActiveRideScreen.kt`

Full-screen map layout (mirroring DriverHomeScreen pattern):
- **GoogleMapView** fills screen; shows driver + pickup marker + route polyline
- **Status banner** (top-right card, animated color):
  - `PENDING` / `ARRIVED_AT_PICKUP` → green "You are on the way" / "You have arrived"
  - `IN_PROGRESS` → blue "Rider in vehicle · X min · Y km"
- **Bottom card** with CTA button:
  - PENDING → "I've Arrived" (arriveAtPickup)
  - ARRIVED_AT_PICKUP → "Start Ride" (startRide)
  - IN_PROGRESS → "Complete Ride" (completeRide)
  - Disabled with spinner while `isActionInProgress`
- **Route/address info** — pickup and dropoff addresses
- **Message button** (stub) → snackbar "Chat feature coming soon"
- **Error snackbar**

Icon fix: `Icons.Default.Chat` deprecated → `Icons.AutoMirrored.Filled.Chat`

---

## Feature 3: DriverTripCompletionScreen + DriverTripCompletionViewModel

### DriverTripCompletionViewModel

**File:** `apps/mobile/app/src/main/java/com/wheelsongo/app/ui/screens/driver/DriverTripCompletionViewModel.kt` (NEW)

```kotlin
data class DriverTripCompletionUiState(
    val ride: RideResponse? = null,
    val riderName: String = "",
    val isLoading: Boolean = false
)
```

`initialize(rideId, riderName)` — loads ride via `RideRepository.getRideById()`. Rider name passed from navigation args (populated from `DriverHomeViewModel.acceptedRiderName` at dispatch time).

### DriverTripCompletionScreen

**File:** `apps/mobile/app/src/main/java/com/wheelsongo/app/ui/screens/driver/DriverTripCompletionScreen.kt` (NEW — cleaned up)

Post-trip summary showing:
- "You have arrived at your destination." headline
- Completion timestamp (formatted: `Feb 20, 2026 | 02:15 PM`)
- Duration + distance banner (green card)
- Pickup → Dropoff addresses
- Customer section: initials avatar + name + fare (`₱<amount>`)
- Message button (stub) → snackbar "Chat feature coming soon"
- Payment method chip
- **"Go to Home"** CTA — calls `onGoHome()` (wired to clear activeRideId and navigate home)

Helpers:
- `String.initials()` — same as DriveRequestsScreen
- `paymentLabel(method)` — GCASH→GCash, CARD→Card, else Cash
- `formatDateTime(isoString)` — `yyyy-MM-dd'T'HH:mm:ss.SSS'Z'` → `MMM dd, yyyy | hh:mm a`

Warning cleanup: removed unused imports (`rememberCoroutineScope`, `kotlinx.coroutines.launch`, `java.util.Date`); fixed `Icons.AutoMirrored.Filled.Chat`.

---

## Feature 4: Backend Dispatch Payload Normalization

**File:** `apps/api/src/dispatch/dispatch.gateway.ts`

### fetchFullRide(rideId)

New private method that queries the ride with rider profile:
```typescript
private async fetchFullRide(rideId: string): Promise<any> {
  return this.dispatchService['prisma'].ride.findUnique({
    where: { id: rideId },
    include: { rider: { select: { id, firstName, lastName, phoneNumber } } },
  });
}
```

### buildRideData(ride)

Normalizes Prisma ride fields to mobile-compatible flat structure:
```typescript
private buildRideData(ride: any): Record<string, any> {
  return {
    id: ride.id,
    riderName: `${firstName} ${lastName}`.trim() || 'Customer',
    pickupAddress, dropoffAddress,
    pickupLat: ride.pickupLatitude,   // NOT pickupLat (DB column name differs)
    pickupLng: ride.pickupLongitude,
    estimatedFare, estimatedDistance, estimatedDuration,
    paymentMethod, rideType, status
  };
}
```

Applied to all 4 dispatch paths:
- `initiateDispatch()` — ride creation dispatch
- `handleDispatchDecline()` — next driver dispatch on decline
- `handleConnection()` — pending dispatch replay on reconnect
- `notifySelectedDriver()` — rider-selected driver dispatch

---

## Feature 5: DispatchSocketClient Nested-JSON Fix

**File:** `apps/mobile/app/src/main/java/com/wheelsongo/app/data/network/DispatchSocketClient.kt`

Backend `dispatch:request` event shape:
```json
{
  "dispatchAttemptId": "...",
  "ride": { "id": "...", "riderName": "...", "pickupLat": 14.5, ... }
}
```

Before fix: `jsonToMap()` was called on the top-level JSON, so `riderName`, `pickupLat`, etc. were missing (they live inside the nested `ride` object).

After fix: parse top-level to extract `dispatchAttemptId` and `ride` sub-object; call `jsonToMap()` only on the `ride` sub-object.

---

## Bug Fix 1 (Critical): activeRideId Navigation Loop

### Root Cause

`DriverHomeViewModel.checkForActiveRide()` sets `activeRideId` when an active ride is found on startup. `DriverHomeScreen.LaunchedEffect(uiState.activeRideId)` navigates to `DriverActiveRideScreen` when `activeRideId` is non-null — but **never cleared it** after navigating.

After completing a trip:
1. `DriverTripCompletionScreen` → "Go to Home" → `popUpTo(0) { inclusive = true }`
2. Home composable remounts; `DriverHomeViewModel` persists (tied to Activity lifecycle)
3. `activeRideId` is still non-null → `LaunchedEffect` fires again → driver immediately pushed back into `DriverActiveRideScreen` for the already-completed ride

### Fix

**`DriverHomeViewModel.kt`** — added `clearActiveRideState()`:
```kotlin
fun clearActiveRideState() {
    _uiState.update { it.copy(
        activeRideId = null,
        acceptedRideId = null,
        acceptedRiderName = ""
    ) }
}
```

**`DriverHomeScreen.kt`** — added `clearActiveRideState()` call before navigating:
```kotlin
LaunchedEffect(uiState.activeRideId) {
    val rideId = uiState.activeRideId
    if (rideId != null && uiState.acceptedRideId == null) {
        viewModel.clearActiveRideState()   // ← added
        onNavigateToActiveRide(rideId)
    }
}
```

**`AppNav.kt`** — get shared `DriverHomeViewModel` from Home back-stack entry and call `clearActiveRideState()` on "Go to Home":
```kotlin
val homeEntry = try { navController.getBackStackEntry(Route.Home.value) } catch (e: Exception) { null }
val driverHomeViewModel: DriverHomeViewModel? = homeEntry?.let { viewModel(it) }

DriverTripCompletionScreen(
    rideId = rideId,
    riderName = riderName,
    onGoHome = {
        driverHomeViewModel?.clearActiveRideState()
        navController.navigate(Route.Home.value) {
            popUpTo(0) { inclusive = true }
        }
    }
)
```

---

## Bug Fix 2 (Minor UX): Fare Format ₱1500.0 → ₱1500

### Root Cause

`DispatchSocketClient.jsonToMap()` converts all JSON values to strings via `optString()`. Backend sends `estimatedFare: 1500` (number) → mobile receives `"1500.0"` (because Kotlin's JSON parser coerces the number to Double, then stringifies it). The ride request card rendered `₱1500.0`.

### Fix

**`DriverHomeViewModel.kt`** — `handleDispatchEvent()` IncomingRideRequest branch:
```kotlin
// Before:
estimatedFare = data["estimatedFare"] ?: "---",

// After:
estimatedFare = data["estimatedFare"]?.toDoubleOrNull()?.let { "%.0f".format(it) } ?: "---",
```

Result: `"1500.0"` → parsed as `1500.0` → formatted as `"1500"` → card renders `₱1500`.

---

## Navigation Updates (AppNav.kt)

Added `DriverTripCompletion` destination with `rideId` and `riderName` args. Full driver navigation flow:

```
DriverHome → DriveRequests → (dispatch accepted) → DriverActiveRide → (complete ride) → DriverTripCompletion → DriverHome
```

Removed unused `backStackEntry ->` lambda parameter from `Route.Home.value` composable.

---

## Test Results

### Backend
```
Test Suites: 13 passed, 13 total
Tests:       122 passed, 122 total   (+1 vs previous 121)
```
1 new test added in this sprint. All existing 121 tests continue to pass — no regressions from `dispatch.gateway.ts` changes.

### Mobile
- 12 test files (7 Phase 1 + 5 Phase 2) — code compiles fine
- Test execution blocked by JBR-21.0.10 JVM GC crash (EXCEPTION_ACCESS_VIOLATION in G1FullGCMarker)
- APK builds and packages successfully

---

## Non-Critical Issues (Deferred)

| Issue | Notes |
|-------|-------|
| `fetchFullRide()` uses `dispatchService['prisma']` string indexing | Anti-pattern. Inject PrismaService directly in a future refactor sprint |
| `dispatch:accepted` sends raw Prisma ride (not `buildRideData`) | Mobile only reads `id` from this event — works correctly. Could normalize for consistency |
| SQL injection in `dispatch.service.ts` line 67-70 | Pre-existing, not introduced in this sprint. Flag for dedicated security fix |
| `OptimisticAccept/Decline` | Removes request from pending list before server confirms. Acceptable UX trade-off |
