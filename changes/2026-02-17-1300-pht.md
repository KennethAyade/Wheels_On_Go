# Firebase App Check + Auth Bug Fixes

**Date:** 2026-02-17 13:00 PHT
**Type:** Bug fixes + Security hardening

---

## Summary

Three separate issues resolved:
1. **Firebase "missing valid app identifier"** — root cause: adding SHA-256 to Firebase Console activated Play Integrity path, but App Check SDK was not installed
2. **Resend OTP bypassed Firebase** — resendOtp() was always calling backend instead of detecting real phone vs emulator
3. **Vehicle 409 with no existing vehicle shown** — no idempotency, no error message parsing, no list auto-refresh

---

## Fix 1: Firebase App Check Integration

### Root Cause
Adding SHA-256 fingerprint to Firebase Console activates the Play Integrity verification path. Firebase then requires App Check SDK to provide attestation tokens. Without App Check, Play Integrity fails AND reCAPTCHA fallback also fails (device was still in cooldown from earlier blocking), producing "This request is missing a valid app identifier."

### Changes

**`apps/mobile/app/build.gradle.kts`**
```kotlin
// Added:
implementation("com.google.firebase:firebase-appcheck-debug:19.0.2")
implementation("com.google.firebase:firebase-appcheck-playintegrity:19.0.2")
// Note: artifact IDs use "appcheck" (no hyphen), not "app-check"
```

**`apps/mobile/app/src/main/java/com/wheelsongo/app/WheelsOnGoApplication.kt`**
- Added Firebase App Check initialization
- Debug builds: `DebugAppCheckProviderFactory` (generates UUID debug token)
- Release builds: `PlayIntegrityAppCheckProviderFactory`

**`apps/mobile/.../data/auth/FirebasePhoneAuthHelper.kt`**
- Timeout increased: 60s → 120s (allows time for reCAPTCHA)
- Added `RateLimited` and `RecaptchaRequired` to `FirebaseVerificationResult` sealed class
- `onVerificationFailed` now detects `FirebaseTooManyRequestsException` → `RateLimited`, `FirebaseAuthInvalidCredentialsException` → `RecaptchaRequired`
- Import fixed: `FirebaseTooManyRequestsException` is in `com.google.firebase` (not `com.google.firebase.auth`)

**`apps/mobile/.../ui/screens/auth/PhoneInputViewModel.kt`**
- Handles `RateLimited` → "Too many requests. Please wait 1 hour..."
- Handles `RecaptchaRequired` → "Verification could not be completed..."

**`apps/mobile/.../ui/screens/auth/OtpVerificationViewModel.kt`**
- Same new result type handling in resend Firebase path

### Firebase Console Steps Completed
- SHA-256 fingerprint `C1:5D:14:20:...` added to Android app
- Test phone `+639761337834` whitelisted with code `123456`
- App Check debug token `d5658fda-cf5b-4fd4-9737-25d81560a362` registered as "Wheels-On-Go-Dev-Machine"

---

## Fix 2: Resend OTP Always Used Backend

### Root Cause
`resendOtp()` in `OtpVerificationViewModel` did not check `DeviceUtils.isEmulator()`. On real phones, it always called `resendViaBackend()` (Textbelt), which fails on Render since Textbelt is not configured for production.

### Changes

**`apps/mobile/.../ui/screens/auth/OtpVerificationViewModel.kt`**
- `resendOtp()` now accepts `activity: Activity?` and `verificationId: String?`
- Routes to `resendViaFirebase()` when `!isEmulator && activity != null && verificationId != null`
- Routes to `resendViaBackend()` on emulators

**`apps/mobile/.../ui/screens/auth/OtpVerificationScreen.kt`**
- Resend button now extracts `val activity = context as? Activity`
- Passes `activity` and `verificationId` to `viewModel.resendOtp()`

---

## Fix 3: Vehicle 409 Without Showing Existing Vehicle

### Root Cause (3 parts)
1. **Backend not idempotent** — `createVehicle()` always threw 409 if plate existed, even for the same rider
2. **Mobile silent error** — `VehicleRepository` used `response.message()` (HTTP status text) instead of parsing the NestJS JSON error body
3. **List stale after navigation** — `VehicleListScreen` and `BookingConfirmScreen` did not refresh when returning from vehicle registration

### Changes

**`apps/api/src/rider-vehicle/rider-vehicle.service.ts`**
- Checks if existing vehicle belongs to same rider → returns existing (idempotent)
- Only throws `ConflictException` if a different rider owns the plate

**`apps/api/test/rider-vehicle.service.spec.ts`**
- Added idempotency test: same rider + same plate → returns existing vehicle
- Updated conflict test: different rider + same plate → ConflictException

**`apps/mobile/.../data/models/ErrorResponse.kt`** (NEW)
```kotlin
@JsonClass(generateAdapter = true)
data class ErrorResponse(val statusCode: Int, val message: String, val error: String? = null)
```

**`apps/mobile/.../data/repository/VehicleRepository.kt`**
- Added `Moshi` adapter + `parseErrorMessage()` method
- Applied to all 4 API methods (createVehicle, getVehicles, deleteVehicle, setDefaultVehicle)

**`apps/mobile/.../ui/screens/vehicle/VehicleListScreen.kt`**
- Added `DisposableEffect` with `LifecycleEventObserver` on `Lifecycle.Event.ON_RESUME`
- Auto-calls `viewModel.loadVehicles()` when screen resumes

**`apps/mobile/.../ui/screens/booking/BookingConfirmScreen.kt`**
- Same `DisposableEffect` pattern for auto-refresh on resume

**`apps/mobile/.../ui/screens/booking/BookingConfirmViewModel.kt`**
- Changed `fetchVehicles()` from `private` to `public` (required by lifecycle observer)

---

## Database Reset

- Ran `npx prisma migrate reset --force` on Render PostgreSQL
- All tables dropped and recreated from migrations
- Clean state for fresh testing

---

## Test Status
- Backend: 121 tests passing (13 suites)
- Mobile: 12 test files compile OK; execution blocked by JBR-21 JVM GC crash
