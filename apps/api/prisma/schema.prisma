generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  RIDER
  DRIVER
  ADMIN
}

enum OtpPurpose {
  LOGIN
  REGISTER
}

enum DriverStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DriverDocumentType {
  LICENSE
  ORCR
  GOVERNMENT_ID
  PROFILE_PHOTO
}

enum DocumentStatus {
  PENDING_UPLOAD
  UPLOADED
  REJECTED
}

model User {
  id           String      @id @default(uuid())
  phoneNumber  String      @unique
  countryCode  String?
  role         UserRole
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  lastLoginAt  DateTime?
  driverProfile DriverProfile?
  otpCodes     OtpCode[]
  auditLogs    AuditLog[]
}

model OtpCode {
  id            String     @id @default(uuid())
  phoneNumber   String
  role          UserRole
  codeHash      String
  expiresAt     DateTime
  consumedAt    DateTime?
  failedAttempts Int       @default(0)
  purpose       OtpPurpose
  createdAt     DateTime   @default(now())
  userId        String?
  user          User?      @relation(fields: [userId], references: [id])

  @@index([phoneNumber])
  @@index([expiresAt])
}

model DriverProfile {
  id                      String    @id @default(uuid())
  userId                  String    @unique
  user                    User      @relation(fields: [userId], references: [id])
  status                  DriverStatus @default(PENDING)
  rejectionReason         String?
  profilePhotoKey         String?
  profilePhotoUploadedAt  DateTime?
  biometricVerifiedAt     DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  documents               DriverDocument[]
  biometricVerifications  BiometricVerification[]
}

model DriverDocument {
  id              String             @id @default(uuid())
  driverProfileId String
  driverProfile   DriverProfile      @relation(fields: [driverProfileId], references: [id])
  type            DriverDocumentType
  storageKey      String
  fileName        String
  mimeType        String
  status          DocumentStatus     @default(PENDING_UPLOAD)
  size            Int?
  uploadedAt      DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@unique([driverProfileId, type])
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String?
  actor       User?    @relation(fields: [actorUserId], references: [id])
  action      String
  targetType  String
  targetId    String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([targetType, targetId])
}

model BiometricVerification {
  id              String        @id @default(uuid())
  driverProfileId String
  driverProfile   DriverProfile @relation(fields: [driverProfileId], references: [id])
  success         Boolean
  reason          String?
  confidence      Float?
  createdAt       DateTime      @default(now())
}
